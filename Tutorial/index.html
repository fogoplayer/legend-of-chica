<!doctype html>
<html lang="en">
<head>
    <meta charset='UTF-8'>
    <title>My First Phaser App</title>
    <link rel='shortcut icon' href='./assets/star.png' type='image/x-icon'>
    <script src='./phaser.js'></script>
    <meta name="viewport" content="initial-scale=1.0" />
    <style type='text/css'>
        body {
            margin:0;
        }
    </style>
</head>

<body>

<script type='module'>
    import dude from './sprites/dude/dude.js';
    
    const config = {
        type:Phaser.AUTO,
        width:800,
        height: 600,
        physics:{
            default: 'arcade',
            arcade: {
                gravity: { y: 300 },
                debug: false
            }
        },
        scene: {
            preload:preload,
            create:create,
            update: update,
        }
    }
    
    let game = new Phaser.Game(config);
    game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;

    let vars = {
        /*player,
        platforms,
        stars,
        bombs,
        cursors,
        scoreText,*/
        score: 0,
    }
    
    function preload(){
        this.load.image('sky', './assets/sky.png');
        this.load.image('ground', './assets/platform.png');
        this.load.image('star', './assets/star.png');
        this.load.image('bomb', './assets/bomb.png');
        dude.preload(this)
    }
    
    function create(){
        this.add.image(400,300, 'sky');
        
        //Platforms--------------------------------------------------------------------------------
        vars.platforms = this.physics.add.staticGroup();
        vars.platforms.create(400,568, 'ground').setScale(2).refreshBody();
        vars.platforms.create(600, 400, 'ground');
        vars.platforms.create(50, 250, 'ground');
        vars.platforms.create(750, 220, 'ground');
        
        //vars.player-----------------------------------------------------------------------------------
        dude.create(this,vars);
        
        //Stars------------------------------------------------------------------------------------
        vars.stars = this.physics.add.group({
            key: 'star',
            repeat: 11,
            setXY: { x: 12, y: 0, stepX: 70 }
        });

        vars.stars.children.iterate(function (child) {

            child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

        });
        
        //Bombs
        vars.bombs = this.physics.add.group();
        
        //Cursors----------------------------------------------------------------------------------
        vars.cursors = this.input.keyboard.createCursorKeys();
        
        //Collider Code----------------------------------------------------------------------------
        this.physics.add.collider(vars.player, vars.platforms);
        this.physics.add.collider(vars.stars, vars.platforms);

        this.physics.add.overlap(vars.player, vars.stars, collectStar, null, this);
        
        this.physics.add.collider(vars.bombs, vars.platforms);
        this.physics.add.collider(vars.player, vars.bombs, hitBomb, null, this);

        
        //Text
        vars.scoreText = this.add.text(16, 16, 'vars.score: 0', { fontSize: '32px', fill: '#000' });
        
    }
    
    function update(){
        dude.update(this, vars);
    }
    
    function collectStar (player, star)
    {
        star.disableBody(true, true);

        vars.score += 10;
        vars.scoreText.setText('Score: ' + vars.score);
    
        if (vars.stars.countActive(true) === 0)
        {
            vars.stars.children.iterate(function (child) {
    
                child.enableBody(true, child.x, 0, true, true);
    
            });
    
            var x = (vars.player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);
    
            var bomb = vars.bombs.create(x, 16, 'bomb');
            bomb.setBounce(1);
            bomb.setCollideWorldBounds(true);
            bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
            bomb.allowGravity = true;
    
        }
    }
    
    function hitBomb (player,bomb){
        this.physics.pause();

        vars.player.setTint(0xff0000);
    
        vars.player.anims.play('turn');
    
        vars.gameOver = true;
    }
</script>

</body>
</html>